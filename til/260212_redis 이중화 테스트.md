## redis 이중화 테스트 시 확인 사항

---

1. vip 에서 로그인해서 토큰 잘 응답하나 보기

2. 리프레쉬 토큰을 redis 에 잘 저장하나 보기
```bash
# redis-cli 시작
redis-cli
redis-cli -c  # 명령어 안 먹으면 이거 입력해보기

# 저장된 리프레쉬토큰 확인
scan 0

# (현재 기준) 특정 유저의 리프레쉬토큰 확인
## 이 때 userSession:master@sbit.co.kr 가 key임
hgetall userSession:master@sbit.co.kr
```

3. failover 테스트
- Redis 프로세스 kill	
  - master 서버에서 systemctl stop redis 하고 vip 이동하는지 확인
  - master 서버인지는 redis-cli info replication 으로 확인- 
  1) 로그인 → refresh token 발급
  2) MASTER 장애 발생
  3) refresh 요청성공해야 진짜 이중화 성공
- 네트워크 down	vm 끄고 vip 이동하는지 확인

4. 토큰 refresh 성공
- 클라이언트가 Refresh Token으로 재발급 요청
- 현재는 아래 API 로 요청하면 새로운 토큰들 발급됨. 별도의 리프레쉬 API 는 필요하지 않을듯
  - @PostMapping(value = "/session", produces = MediaType.APPLICATION_JSON_VALUE)
  * 설정 > 사용자 세션 타임아웃 주기 설정 값에 따라서 일반 사용자는 자동 로그아웃된다
  * 그러나 타임아웃 주기 내에 조금이라도 동작이 있었다면 세션이 연장된다
  * 이 세션 타임아웃 주기가 access token 만료 기한이다 

5. 재부팅 후 데이터 유지 (AOF)
- 현재는 AOF(Append Only File) 비활성 상태
- redis-cli config get appendonly 실행 결과
1) "appendonly"
2) "no”
- 대신 RDB 에 저장하여 redis 재부팅해도 데이터 날아가지 않도록 함
  - redis-cli config get save 실행 결과
  1) "save"
  2) "900 1 300 10 60 10000”

6. redis replication 확인
- replication 설정이 되어 있어야 한 쪽에서 토큰 저장하고 리프레쉬하고 할 떄 클러스터링된 다른 db 서버에도 반영됨
- 확인 방법
```bash
redis-cli info replication
```
- 실행 결과 
role:master
connected_slaves:1
slave0:ip=172.16.10.200,port=6379,state=online,offset=18733,lag=0
master_replid:7b7f47957c5ed1b1c9b957d295d67142650ef2d1
master_replid2:de0aefdfe2c45433795af5e442c4f0eebdc8d210
master_repl_offset:18733
second_repl_offset:2925
repl_backlog_active:1
repl_backlog_size:1048576
repl_backlog_first_byte_offset:1
repl_backlog_histlen:18733
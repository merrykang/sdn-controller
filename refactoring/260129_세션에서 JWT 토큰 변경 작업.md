# 세션 → JWT 토큰 변경 작업 테스트

## 1. 작업 목적
- 세션 기반 인증 제거
- JWT + Refresh Token + Redis 기반 인증 전환
- Stateless API 구조 유지
- 동시 로그인 정책 유지

---

## 2. Spring Security / Session 설정 검증

### 2.1 세션 비활성화
```java
.sessionManagement()
.sessionCreationPolicy(SessionCreationPolicy.STATELESS)

// JSESSIONID 미발급
// 서버 세션 생성 없음
```

### 2.2 Spring Session(JDBC) 제거
- @EnableJdbcHttpSession 주석 처리
- sessionConfig 미사용
- SPRING_SESSION 테이블 미사용 확인
```java
spring.session.store-type=jdbc
spring.session.jdbc.initialize-schema=always
spring.session.jdbc.schema=classpath:org/springframework/session/jdbc/schema-mysql.sql
spring.session.jdbc.flush-mode=on-save
spring.session.jdbc.save-mode=on-set-attribute
// Spring Session 전용 설정
// 주석 처리 후 로그인 정상 동작
```

## 3. 로그인 성공 처리 변경
1. 기존 (세션 기반)
- HttpSession 저장
- X-Session-Version 헤더 사용

2. 변경 (JWT 기반)
- Access / Refresh Token 발급
- Access Token TTL을 Keycloak 설정 기반으로 계산

## 4. 사용자 세션 정보 Redis 저장

- 저장 정보:
  - userId
  - accessToken
  - refreshToken
  - clientIp
  - authorities
  - expiration(TTL)

### 5. 로그인 API 헤더 확인
- Authorization 헤더 사용
- Set-Cookie 없음
- 세션 관련 헤더 제거 확인

### 6. 로그아웃 로직 검증
```java
// 제거 코드
.invalidateHttpSession(true)
.deleteCookies("JSESSIONID")
// 로그아웃 response에 Set-Cookie 없음
// 서버 세션 무효화 없음
```

### 7. Refresh Token 검증
1. 설정 기준
- JWT payload의 azp 값 기준 Client Realm 설정 적용
- Realm 전체 설정보다 Client 설정 우선
- Access Token 만료
- Access Token 만료

2. API 호출 → 401
- Refresh Token 재발급

3. API 재호출 → 200
- Refresh Token 만료
- Refresh 요청 실패
- 프론트 강제 로그아웃

### 8. JWT Filter 확인
- 인증 진입점: JWT Filter
- Authorization 헤더 기반 인증
- SecurityContext는 토큰 기반
- UserAuthInfo는 JWT 정보만 포함

### 9. SSE 인증 상태
- JWT 직접 파싱 ❌
- SecurityContext 기반 인증
- 완전 Stateless SSE 아님

### 10. Redis 인증 상태 검증
1. 확인
```bash
redis-cli
keys *
```
2. 검증 포인트
- Refresh Token이 Redis에 반드시 저장됨
- Redis에 없는 Refresh Token은 재발급 불가
- Refresh 요청 시 기존 Refresh Token 폐기
- 이전 Refresh Token 재사용 불가

### 11. 동시 로그인 정책
1. 기존 (세션)
- /user/session/check
- 기존 세션 강제 종료

2. JWT 기반 정책
- Refresh Token 기준 단일 로그인 유지
- 신규 로그인 시 기존 Refresh Token 폐기
- Access Token은 짧은 TTL로 자연 만료
- ⚠️ 세션 관리 클래스 유지 시 정책 붕괴 가능